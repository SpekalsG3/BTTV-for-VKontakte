var bttvForVKNS = {
  bttvEmotes: {"2Head":{"id":"294078","frankerfacez":true,"size":"1","animated":false,"author":"Visoraph"},"3Head":{"id":"274406","frankerfacez":true,"size":"1","animated":false,"author":"timmytoina"},"4HEad":{"id":"128247","frankerfacez":true,"size":"1","animated":false,"author":"Asayuna"},"4HEader":{"id":"165784","frankerfacez":true,"size":"1","animated":false,"author":"KaiOwei"},"4House":{"id":"230495","frankerfacez":true,"size":"1","animated":false,"author":"a_minglee"},"5Head":{"id":"5d6096974932b21d9c332904","frankerfacez":false,"size":"1x","author":"onmarked","animated":false},"AYAYA":{"id":"58493695987aab42df852e0f","frankerfacez":false,"size":"1x","author":"Zigrin","animated":false},"Agakakskagesh":{"id":"58a57fa706e70d0465b29cd3","frankerfacez":false,"size":"1x","author":"Arthas","animated":true},"AwkwardFlushed":{"id":"5e15ccf3b640b52102c67fee","frankerfacez":false,"size":"1x","author":"XxXxXxXxXx420xXxXxXxXxX","animated":true},"BBoomer":{"id":"5c447084f13c030e98f74f58","frankerfacez":false,"size":"1x","author":"Leitt","animated":true},"BigBossF":{"id":"5d484ad025570a0ac7e814c7","frankerfacez":false,"size":"1x","author":"UselessMouth","animated":false},"Clap":{"id":"55b6f480e66682f576dd94f5","frankerfacez":false,"size":"1x","author":"TurtleMaw","animated":true},"D:":{"id":"55028cd2135896936880fdd7","frankerfacez":false,"size":"1x","author":"NightDev","animated":false},"DANKHACKERMANS":{"id":"5e37903f61ff6b51e652837c","frankerfacez":false,"size":"1x","author":"mammothb","animated":true},"Dance":{"id":"5aa1d0e311237146531078b0","frankerfacez":false,"size":"1x","author":"BlatnoyTheBest","animated":true},"EZ":{"id":"5590b223b344e2c42a9e28e3","frankerfacez":false,"size":"1x","author":"helloboat","animated":false},"FEELSWAYTOOGOOD":{"id":"5e1891efbca2995f13fb29a4","frankerfacez":false,"size":"1x","author":"Happinson","animated":true},"FeelsBadMan":{"id":"566c9fc265dbbdab32ec053b","frankerfacez":false,"size":"1x","author":"NightDev","animated":false},"FeelsDankMan":{"id":"5d6209854932b21d9c333195","frankerfacez":false,"size":"1x","author":"ALazyMeme","animated":false},"FeelsExhaustedMan":{"id":"5c73f0b141600b0832ab22cd","frankerfacez":false,"size":"1x","author":"HustiLivestream","animated":false},"FeelsGoodMan":{"id":"566c9fde65dbbdab32ec053e","frankerfacez":false,"size":"1x","author":"NightDev","animated":false},"FeelsOkayMan":{"id":"5803757f3d506fea7ee35267","frankerfacez":false,"size":"1x","author":"Acidy_","animated":false},"FeelsRageMan":{"id":"5597e66ed8152e272470f830","frankerfacez":false,"size":"1x","author":"Mrsam18","animated":false},"FeelsRainMan":{"id":"57850b9df1bf2c1003a88644","frankerfacez":false,"size":"1x","author":"gerych","animated":true},"FeelsStrongMan":{"id":"58facc4aaffae60eac088397","frankerfacez":false,"size":"1x","author":"justmaple","animated":false},"FeelsSupportMan":{"id":"5b7a0494ed39d816f122ebc5","frankerfacez":false,"size":"1x","author":"Daniil_KnyaZz","animated":false},"FeelsTastyMan":{"id":"59474044e949fe3b435e3135","frankerfacez":false,"size":"1x","author":"TastyMcPanda","animated":false},"FeelsUpMan":{"id":"5d48377baff6f30ad530a112","frankerfacez":false,"size":"1x","author":"UselessMouth","animated":false},"FeelsWeirdMan":{"id":"5603731ce5fc5eff1de93229","frankerfacez":false,"size":"1x","author":"Geirrr","animated":false},"FireSpeed":{"id":"566c9ff365dbbdab32ec0541","frankerfacez":false,"size":"1x","author":"NightDev","animated":false},"FreeBear":{"id":"5a9df6a0ac743774ef9bc74b","frankerfacez":false,"size":"1x","author":"skinnedteen","animated":true},"GabeN":{"id":"54fa90ba01e468494b85b543","frankerfacez":false,"size":"1x","author":"NightDev","animated":false},"GachiPls":{"id":"58868aa5afc2ff756c3f495e","frankerfacez":false,"size":"1x","author":"RemeZZZ","animated":true},"GuitarTime":{"id":"576befd71f520d6039622f7e","frankerfacez":false,"size":"1x","author":"Reckful","animated":true},"HACKERMANS":{"id":"5b490e73cf46791f8491f6f4","frankerfacez":false,"size":"1x","author":"numrii","animated":true},"HAhaa":{"id":"55f47f507f08be9f0a63ce37","frankerfacez":false,"size":"1x","author":"sven_snusberg_official","animated":false},"HYPERBASS":{"id":"5b4d0bb1a13f8e3953e2819b","frankerfacez":false,"size":"1x","author":"sparklinNeko","animated":true},"HYPERS":{"id":"5980af4e3a1ac5330e89dc76","frankerfacez":false,"size":"1x","author":"tO_Ot","animated":false},"HandsUp":{"id":"5e3edf06e383e37d5d9d1dfd","frankerfacez":false,"size":"1x","author":"deanpcmad","animated":false},"Jokin":{"id":"5d483c82aff6f30ad530a13b","frankerfacez":false,"size":"1x","author":"UselessMouth","animated":false},"KEKW":{"id":"5e9c6c187e090362f8b0b9e8","frankerfacez":false,"size":"1x","author":"M3T4M0RF","animated":false},"KEKWait":{"id":"5e486af4d736527d5cd2fed6","frankerfacez":false,"size":"1x","author":"TheMisterRobot","animated":false},"KKomrade":{"id":"56be9fd6d9ec6bf74424760d","frankerfacez":false,"size":"1x","author":"garych","animated":false},"KKonaW":{"id":"598215f47e71d43314a80ad2","frankerfacez":false,"size":"1x","author":"BillyCx","animated":false},"KKool":{"id":"56c2cff2d9ec6bf744247bf1","frankerfacez":false,"size":"1x","author":"garych","animated":true},"KKoooona":{"id":"164405","frankerfacez":true,"size":"1","animated":false,"author":"Zugren"},"LULW":{"id":"5dc79d1b27360247dd6516ec","frankerfacez":false,"size":"1x","author":"Rain_Song","animated":false},"LawBear":{"id":"5be0b13c0aabfd2d7273a39a","frankerfacez":false,"size":"1x","author":"WopGopPrivet","animated":true},"Leddit":{"id":"5de847afe7df1277b606d888","frankerfacez":false,"size":"1x","author":"Laden","animated":true},"MEGALUL":{"id":"5e49b8f1e383e37d5d9d931c","frankerfacez":false,"size":"1x","author":"Trolltuske","animated":false},"MaN":{"id":"266564","frankerfacez":true,"size":"1","animated":false,"author":"FullMetalB"},"NaM":{"id":"566ca06065dbbdab32ec054e","frankerfacez":false,"size":"1x","author":"NightDev","animated":false},"OMEGALUL":{"id":"583089f4737a8e61abb0186b","frankerfacez":false,"size":"1x","author":"worthlessvoid","animated":false},"OkayChamp":{"id":"5d2eb3dfabb461681ab7d4fb","frankerfacez":false,"size":"1x","author":"siivagunnerfan69","animated":false},"OkayChamping":{"id":"5ea806c7d023b362f639706b","frankerfacez":false,"size":"1x","author":"NymN","animated":true},"PEPEDS":{"id":"5be9f494a550811484ed2dd4","frankerfacez":false,"size":"1x","author":"Glutek","animated":true},"POGGERS":{"id":"58ae8407ff7b7276f8e594f2","frankerfacez":false,"size":"1x","author":"tO_Ot","animated":false},"PagChomp":{"id":"61496","frankerfacez":true,"size":"1","animated":false,"author":"frumpy4"},"PainsChamp":{"id":"5e285f4a1df9195f1a4cca53","frankerfacez":false,"size":"1x","author":"Sin_4000","animated":false},"PauseChamp":{"id":"5cd6b08cf1dac14a18c4b61f","frankerfacez":false,"size":"1x","author":"Nixi93","animated":false},"PedoBear":{"id":"54fa928f01e468494b85b54f","frankerfacez":false,"size":"1x","author":"NightDev","animated":false},"PeepoGlad":{"id":"244322","frankerfacez":true,"size":"1","animated":false,"author":"RuneBiegelPedersen"},"PeepoRunCry":{"id":"5d8350251df66f68c80c1964","frankerfacez":false,"size":"1x","author":"BibixHD","animated":true},"PepeHands":{"id":"59f27b3f4ebd8047f54dee29","frankerfacez":false,"size":"1x","author":"P3NTAZ","animated":false},"PepeLaugh":{"id":"5c548025009a2e73916b3a37","frankerfacez":false,"size":"1x","author":"KKomrade","animated":true},"PepeLmao":{"id":"214658","frankerfacez":true,"size":"1","animated":false,"author":"Vycilien"},"PepeOK":{"id":"5d48380b25570a0ac7e81454","frankerfacez":false,"size":"1x","author":"UselessMouth","animated":false},"PepeRage":{"id":"5d483cb364ae370ac807ba0d","frankerfacez":false,"size":"1x","author":"UselessMouth","animated":false},"PepeScoots":{"id":"5b9ece3bee018c1569cb8608","frankerfacez":false,"size":"1x","author":"Laden","animated":false},"PepeSpit":{"id":"5e3f1caed736527d5cd29c13","frankerfacez":false,"size":"1x","author":"LetMePetYourDoggo","animated":true},"Pepeeeega":{"id":"286627","frankerfacez":true,"size":"1","animated":false,"author":"Teeemosh"},"Pepega":{"id":"5aca62163e290877a25481ad","frankerfacez":false,"size":"1x","author":"adew","animated":false},"PepegaCredit":{"id":"5e9643a2d023b362f6381be1","frankerfacez":false,"size":"1x","author":"KohWahSkee","animated":true},"PepegaDriving":{"id":"5eb01a0ece7cbf62fe16b9b2","frankerfacez":false,"size":"1x","author":"Drainys","animated":true},"PepegaGun":{"id":"5e247657bca2995f13fbc09d","frankerfacez":false,"size":"1x","author":"STELLAOP","animated":true},"Pepege":{"id":"341610","frankerfacez":true,"size":"1","animated":false,"author":"Agvuie"},"PepoCheer":{"id":"5abd36396723dc149c678e90","frankerfacez":false,"size":"1x","author":"Ron","animated":true},"PepoG":{"id":"5d63e543375afb1da9a68a5a","frankerfacez":false,"size":"1x","author":"vr_virtux","animated":false},"PepoThink":{"id":"174942","frankerfacez":true,"size":"1","animated":false,"author":"Taliiz"},"Pog":{"id":"210748","frankerfacez":true,"size":"1","animated":false,"author":"Teyn"},"PogO":{"id":"5e9cdca974046462f7673006","frankerfacez":false,"size":"1x","author":"MaxDerApfel","animated":false},"PogT":{"id":"5f01f03973e8e20538d7659c","frankerfacez":false,"size":"1x","author":"F1ashko","animated":false},"PogU":{"id":"5e4e7a1f08b4447d56a92967","frankerfacez":false,"size":"1x","author":"ap4ik_","animated":false},"RjombaThoking":{"id":"5d483b569728020aca0da46d","frankerfacez":false,"size":"1x","author":"UselessMouth","animated":false},"Sadge":{"id":"425196","frankerfacez":true,"size":"1","animated":false,"author":"vicneeel"},"SchubertWalk":{"id":"5c707362b80b802336fbb84a","frankerfacez":false,"size":"1x","author":"lostcocaine","animated":true},"Smoke":{"id":"5e06c2338245800d975645fd","frankerfacez":false,"size":"1x","author":"AbooHalab","animated":true},"Spravedjomba":{"id":"5d483a9faff6f30ad530a132","frankerfacez":false,"size":"1x","author":"UselessMouth","animated":false},"Spravedlivo":{"id":"5d4839f7aff6f30ad530a12b","frankerfacez":false,"size":"1x","author":"UselessMouth","animated":false},"TeaTime":{"id":"56f6eb647ee3e8fc6e4fe48e","frankerfacez":false,"size":"1x","author":"Reckful","animated":true},"Thonk":{"id":"585231dd58af204561cd6036","frankerfacez":false,"size":"1x","author":"Skyonis","animated":false},"TriDance":{"id":"5d1e70f498539c4801cc3811","frankerfacez":false,"size":"1x","author":"MarcFryd","animated":true},"WAYTOODANK":{"id":"5ad22a7096065b6c6bddf7f3","frankerfacez":false,"size":"1x","author":"pajlada","animated":true},"WeirdChamp":{"id":"262468","frankerfacez":true,"size":"1","animated":false,"author":"nedddus"},"WeirdChamping":{"id":"5e9e0eb47e090362f8b0d9a4","frankerfacez":false,"size":"1x","author":"NymN","animated":true},"Weirdga":{"id":"294523","frankerfacez":true,"size":"1","animated":false,"author":"adew"},"WineTime":{"id":"5c8b071bc9b377041a1b2506","frankerfacez":false,"size":"1x","author":"igor_baryshev","animated":true},"YEP":{"id":"418189","frankerfacez":true,"size":"1","author":"yaYEET_xD","animated":false},"aRolf":{"id":"5d48374d9728020aca0da45b","frankerfacez":false,"size":"1x","author":"UselessMouth","animated":false},"ayayaJAM":{"id":"5c36c6981a0b6956017d6b01","frankerfacez":false,"size":"1x","author":"TheFloppyTortilla","animated":true},"ayyPls":{"id":"5d48463c9728020aca0da4b0","frankerfacez":false,"size":"1x","author":"UselessMouth","animated":true},"bUrself":{"id":"566c9f3b65dbbdab32ec052e","frankerfacez":false,"size":"1x","author":"NightDev","animated":false},"billyReady":{"id":"58763fcecb2b7248f8b9b0cf","frankerfacez":false,"size":"1x","author":"Kapaleen","animated":true},"blushW":{"id":"5e7625728c0f5c3723a99cc6","frankerfacez":false,"size":"1x","author":"UselessMouth","animated":false},"bttvNice":{"id":"54fab7d2633595ca4c713abf","frankerfacez":false,"size":"1x","author":"NightDev","animated":false},"cvHazmat":{"id":"5e76d338d6581c3724c0f0b2","frankerfacez":false,"size":"1x","modification":"bttv_img-emote--overlay","author":"Night","animated":false},"cvMask":{"id":"5e76d399d6581c3724c0f0b8","frankerfacez":false,"size":"1x","modification":"bttv_img-emote--overlay","author":"Night","animated":false},"danceFrog":{"id":"5ba06b0c852ff34060d12fd3","frankerfacez":false,"size":"1x","author":"iReflex","animated":true},"forsenCD":{"id":"249060","frankerfacez":true,"size":"1","animated":false,"author":"Anatrus"},"gachiBASS":{"id":"57719a9a6bdecd592c3ad59b","frankerfacez":false,"size":"1x","author":"Rooph1e","animated":true},"gachiGASM":{"id":"55999813f0db38ef6c7c663e","frankerfacez":false,"size":"1x","author":"thefreaking2","animated":false},"gachiHYPER":{"id":"59143b496996b360ff9b807c","frankerfacez":false,"size":"1x","author":"XxXxXxXxXx420xXxXxXxXxX","animated":true},"gachiRoll":{"id":"5e50bfef751afe7d553e2a63","frankerfacez":false,"size":"1x","author":"corvaliis","animated":true},"gachiRollBack":{"id":"5e6156d8d112fc372573cf2d","frankerfacez":false,"size":"1x","author":"lethargicwaldo","animated":true},"gachiW":{"id":"5ce66e8c1281d44f03de8051","frankerfacez":false,"size":"1x","author":"XxXxXxXxXx420xXxXxXxXxX","animated":true},"haHAA":{"id":"555981336ba1901877765555","frankerfacez":false,"size":"1x","author":"Sorty96","animated":false},"headBang":{"id":"57320689d69badf9131b82c4","frankerfacez":false,"size":"1x","author":"hewooo","animated":true},"hoSway":{"id":"56396c857e538de14bd747a5","frankerfacez":false,"size":"1x","author":"HOLAhedn","animated":true},"kojimaW":{"id":"584c966c2b6bd742e58cf5d0","frankerfacez":false,"size":"1x","author":"Evident_Deterrent","animated":false},"lickL":{"id":"5afdd15ab5f610729e2f6e7a","frankerfacez":false,"size":"1x","author":"ilarj","animated":true},"lickR":{"id":"5afdd149b5f610729e2f6e75","frankerfacez":false,"size":"1x","author":"ilarj","animated":true},"monkaBan":{"id":"5be43ddea550811484ecf547","frankerfacez":false,"size":"1x","author":"tamaaa","animated":true},"monkaEyes":{"id":"268204","frankerfacez":true,"size":"1","animated":false,"author":"libertyass"},"monkaGun":{"id":"58f6e05e58f5dd226a16166e","frankerfacez":false,"size":"1x","author":"tO_Ot","animated":false},"monkaH":{"id":"201362","frankerfacez":true,"size":"1","animated":false,"author":"Auroreily"},"monkaHmm":{"id":"5aa16eb65d4a424654d7e3e5","frankerfacez":false,"size":"1x","author":"SarcasmDetected","animated":false},"monkaS":{"id":"56e9f494fff3cc5c35e5287e","frankerfacez":false,"size":"1x","author":"Monkasen","animated":false},"monkaSHAKE":{"id":"58d867c84c25f4458349ecc7","frankerfacez":false,"size":"1x","author":"MashJDW","animated":true},"monkaW":{"id":"59ca6551b27c823d5b1fd872","frankerfacez":false,"size":"1x","author":"voparoS_","animated":false},"monkaX":{"id":"58e5abdaf3ef4c75c9c6f0f9","frankerfacez":false,"size":"1x","author":"KingTheTurtle","animated":true},"nymnCorn":{"id":"56cb56f5500cb4cf51e25b90","frankerfacez":false,"size":"1x","author":"NymN","animated":true},"peepoBlanket":{"id":"5d43475f6b7300449a43441c","frankerfacez":false,"size":"1x","author":"waifumatthew","animated":false},"peepoChat":{"id":"5e1bd08688e62a5f14dc6316","frankerfacez":false,"size":"1x","author":"saylermiu","animated":true},"peepoClap":{"id":"5d38aaa592fc550c2d5996b8","frankerfacez":false,"size":"1x","author":"Sharkie_","animated":true},"peepoClown":{"id":"318914","frankerfacez":true,"size":"1","animated":false,"author":"nis5e"},"peepoG":{"id":"5e3026505ea23e51ed8c6617","frankerfacez":false,"size":"1x","author":"guit88man","animated":false},"peepoHappy":{"id":"5a16ee718c22a247ead62d4a","frankerfacez":false,"size":"1x","author":"Seremendal","animated":false},"peepoHey":{"id":"5c0e1a3c6c146e7be4ff5c0c","frankerfacez":false,"size":"1x","author":"bkeepr","animated":true},"peepoHug":{"id":"5a1702fb8c22a247ead62d95","frankerfacez":false,"size":"1x","author":"Seremendal","animated":false},"peepoLeaveWave":{"id":"5de7a4f6e7df1277b606d47d","frankerfacez":false,"size":"1x","author":"SteezysRevenge","animated":true},"peepoLove":{"id":"5a5e0e8d80f53146a54a516b","frankerfacez":false,"size":"1x","author":"SeremendaI","animated":false},"peepoPats":{"id":"5c53afb3c5744c56e7a951d1","frankerfacez":false,"size":"1x","author":"Meistar__","animated":true},"peepoPooPoo":{"id":"5c3427a55752683d16e409d1","frankerfacez":false,"size":"1x","author":"dearsomeone","animated":true},"peepoRIP":{"id":"5edbad3dfdee545e30667995","frankerfacez":false,"size":"1x","author":"ZakvielChannel","animated":false},"peepoRun":{"id":"5bc7ff14664a3b079648dd66","frankerfacez":false,"size":"1x","author":"BigDadi","animated":true},"peepoSad":{"id":"5a16ddca8c22a247ead62ceb","frankerfacez":false,"size":"1x","author":"Seremendal","animated":false},"peepoSmash":{"id":"5c72084d41600b0832ab0931","frankerfacez":false,"size":"1x","author":"atamanman","animated":true},"pepeD":{"id":"5b1740221c5a6065a7bad4b5","frankerfacez":false,"size":"1x","author":"garych","animated":true},"pepeFASTJAM":{"id":"5d24b2b253fb4737754909d4","frankerfacez":false,"size":"1x","author":"MegaCornflakes","animated":true},"pepeJAM":{"id":"5b77ac3af7bddc567b1d5fb2","frankerfacez":false,"size":"1x","author":"ShakoTheWacko","animated":true},"pepeMeltdown":{"id":"5ba84271c9f0f66a9efc1c86","frankerfacez":false,"size":"1x","author":"uhavebadpc","animated":true},"pepeSadJam":{"id":"5baf7cfb9809cc1f5117d301","frankerfacez":false,"size":"1x","author":"alfto","animated":true},"pepeSmoke":{"id":"5b15162147c7bf3bfc0b9c76","frankerfacez":false,"size":"1x","author":"grufalo","animated":true},"pepegaJAMMER":{"id":"5bf1af23cab3fc2b794eb0e5","frankerfacez":false,"size":"1x","author":"Sniatch","animated":true},"polarExtreme":{"id":"5afa12b61260c3359cb41fba","frankerfacez":false,"size":"1x","author":"orgest","animated":true},"ppHopper":{"id":"5b0da25016252035ad06900e","frankerfacez":false,"size":"1x","author":"V4d3z","animated":true},"ppJedi":{"id":"5b52e96eb4276d0be256f809","frankerfacez":false,"size":"1x","author":"garych","animated":true},"ppOverheat":{"id":"5b3e953a2c8a38720760c7f7","frankerfacez":false,"size":"1x","author":"uhavebadpc","animated":true},"ricardoFlick":{"id":"5bc2143ea5351f40921080ee","frankerfacez":false,"size":"1x","author":"Supinic","animated":true},"rjuMen":{"id":"5d483d1d9728020aca0da471","frankerfacez":false,"size":"1x","author":"UselessMouth","animated":false},"roflanEbalo":{"id":"5becd72ef1182871d7e74545","frankerfacez":false,"size":"1x","author":"BlatnoyTheBest","animated":false},"sadCat":{"id":"5b96e7f1bbf4663f648795b1","frankerfacez":false,"size":"1x","author":"EMERILD","animated":false},"sumSmash":{"id":"5af84b9e766af63db43bf6b9","frankerfacez":false,"size":"1x","author":"fREAST","animated":true},"toddGun":{"id":"5e2f13b55e6f5751e76c7e4c","frankerfacez":false,"size":"1x","author":"Ryccs","animated":true},"toddW":{"id":"5e2f129eb1d0ac51e8ece66f","frankerfacez":false,"size":"1x","author":"Ryccs","animated":false},"widepeepoBlanket":{"id":"337645","frankerfacez":true,"size":"1","animated":false,"author":"owmyneck"},"widepeepoHappy":{"id":"270930","frankerfacez":true,"size":"1","animated":false,"author":"black__tic_tac"},"widepeepoSad":{"id":"303899","frankerfacez":true,"size":"1","animated":false,"author":"rSherms"}},
  createElement: function (tag, attrs = {}, children = []) {
    var el = document.createElement(tag);
    for (var attr in attrs)
      el[attr] = attrs[attr];
    for (var child of children)
      el.appendChild(child);
    return el;
  },
  lastPressedTab: false,
  wordStart: 0,
  lastTabbedEmote: 0,
  twoLayers: false,
  activeYNode: 0,
  activeXNode: 0,
  cursorIndex: 0,
  menuScrollOffset: 0,
  menuDraggingBar: false,
  menuStartDraggingPoint: 0,
  lastPointAtBorder: false,
  emotesMenuShown: false,
  settings: {}
}

bttvForVKNS.toImg = function(name) {
  var emote = bttvForVKNS.bttvEmotes[name];
  var imgWrapper = bttvForVKNS.createElement("div", {"className": "bttv_img-wrapper" + (emote.modification !== undefined ? " " + emote.modification : "")}, [
    bttvForVKNS.createElement("img", {
      "src": "https://cdn.betterttv.net/" + (emote.frankerfacez ? "frankerfacez_emote/" : "emote/") + emote.id + "/" + emote.size,
      "className": "bttv_img-emote"
    }),
    bttvForVKNS.createElement("div", {
      "className": "bttv_emote-tooltip",
      "innerHTML": name + "<br>Author: " + emote.author + "<br>" + (emote.frankerfacez ? "FrankerFaceZ Emotes" : "BTTV Emotes")
    })
  ]);

  imgWrapper.addEventListener("mouseover", function() {
    if (this.lastElementChild.className == "bttv_emote-tooltip")
      this.lastElementChild.style.display = "block";
  });
  imgWrapper.addEventListener("mouseout", function() {
    if (this.lastElementChild.className == "bttv_emote-tooltip")
      this.lastElementChild.style.display = "none";
  });
  return imgWrapper;
}
bttvForVKNS.parseEmotes = function(text) {
  var word = "",
      textBefore = "",
      l = text.length,
      nodes = [],
      emote = {};
  for (var i = 0; i <= l; i++) {
    if (text[i] == ' ' || i == l) {
      if ((word in bttvForVKNS.bttvEmotes) &&
          (bttvForVKNS.settings.showGifs || !bttvForVKNS.bttvEmotes[word].animated) &&
          (bttvForVKNS.settings.frankerZEmotes || !bttvForVKNS.bttvEmotes[word].frankerfacez)) {
        if (textBefore != "")
          nodes.push(document.createTextNode(textBefore));
        nodes.push(bttvForVKNS.toImg(word));
        textBefore = "";
        word = "";
      }

      textBefore += (textBefore=='' ? '' : ' ') + word;
      word = "";
    } else {
      word += text[i];
    }
  }
  if (textBefore != "") {
    nodes.push(document.createTextNode(textBefore));
    textBefore = "";
  }
  return nodes;
}
bttvForVKNS.replaceEmotes = function(node) {
  var tmpNode = false, newNode;
  for (var s of node.childNodes) {
    if (s.classList != undefined && s.classList.length > 0) {
      if (s.classList[0] == "im-replied") {
        newNode = s.lastElementChild.lastElementChild;
        s = newNode.firstChild;
        tmpNode = true;
      } else if (s.classList[0].substr(0,13) == "_im_msg_reply" && s.lastElementChild.classList[0] == 'im-replied') {
        newNode = s.lastElementChild.lastElementChild.lastElementChild;
        s = newNode.firstChild;
        tmpNode = true;
      }
    }
    if (s.nodeName == "#text") {
      if (tmpNode) {
        for (var n of bttvForVKNS.parseEmotes(s.nodeValue))
          newNode.insertBefore(n, s);
      }
      else {
        for (var n of bttvForVKNS.parseEmotes(s.nodeValue))
          node.insertBefore(n, s);
      }
      s.remove();
    }
    tmpNode = false;
  }
}
bttvForVKNS.handleScrollBar = function(value, bybar = false) {
  var flag = false;
  if (value > 0) {
    // scroll down
    flag = value > bttvForVKNS.scrollSpace;
    if (flag)
      bttvForVKNS.menuScrollOffset = bttvForVKNS.scrollSpace;
    else
      bttvForVKNS.menuScrollOffset = value;
  } else {
    // scroll up
    flag = value < 0;
    if (flag)
      bttvForVKNS.menuScrollOffset = 0;
    else
      bttvForVKNS.menuScrollOffset = value;
  }
  if (!(bttvForVKNS.lastPointAtBorder === flag && bttvForVKNS.lastPointAtBorder)) {
    bttvForVKNS.scrollbar.style.top = bttvForVKNS.menuScrollOffset*bttvForVKNS.scrollareaHeight/bttvForVKNS.scrollHeight + "px";
    if (bybar)
      bttvForVKNS.emoteScrollable.scrollTop = bttvForVKNS.menuScrollOffset;
  }
  bttvForVKNS.lastPointAtBorder = flag;
}
bttvForVKNS.updateCursorPlacement = function() {
  var sel = window.getSelection();
  if (sel.rangeCount) {
    var range = sel.getRangeAt(0);
    if (range.commonAncestorContainer.parentNode == bttvForVKNS.input) {
      bttvForVKNS.twoLayers = false;
      bttvForVKNS.cursorIndex = range.endOffset;
      var textNode = range.endContainer;
      for (bttvForVKNS.activeYNode = 0; bttvForVKNS.activeYNode < textNode.parentElement.childNodes.length; bttvForVKNS.activeYNode++)
        if (textNode.parentElement.childNodes[bttvForVKNS.activeYNode] == textNode)
          break;
    } else if (bttvForVKNS.input.contains(range.commonAncestorContainer.parentNode)) {
      bttvForVKNS.twoLayers = true;
      bttvForVKNS.cursorIndex = range.endOffset;
      var textNode = range.endContainer;
      for (bttvForVKNS.activeYNode = 0; bttvForVKNS.activeYNode < textNode.parentElement.parentElement.childNodes.length; bttvForVKNS.activeYNode++)
        if (textNode.parentElement.parentElement.childNodes[bttvForVKNS.activeYNode] == textNode.parentElement)
          break;
      for (bttvForVKNS.activeXNode = 0; bttvForVKNS.activeXNode < textNode.parentElement.childNodes.length; bttvForVKNS.activeXNode++)
        if (textNode.parentElement.childNodes[bttvForVKNS.activeXNode] == textNode)
          break;
    } else
      return 1;
  } else
    return 2;
  return 0;
}
bttvForVKNS.insertInEditable = function(name, replace = false) {
  var currentNodeText;
  if (bttvForVKNS.input.childNodes.length > 0) {
    if (bttvForVKNS.twoLayers)
      currentNodeText = bttvForVKNS.input.childNodes[bttvForVKNS.activeYNode].childNodes[bttvForVKNS.activeXNode].nodeValue;
    else
      currentNodeText = bttvForVKNS.input.childNodes[bttvForVKNS.activeYNode].nodeValue;
  }
  else {
    bttvForVKNS.input.append("");
    currentNodeText  = "";
  }
  var spaceBefore = "";
  if (replace) {
    for (bttvForVKNS.wordStart = bttvForVKNS.cursorIndex-1; bttvForVKNS.wordStart >= 0; bttvForVKNS.wordStart--) {
      if (/\s/.test(currentNodeText[bttvForVKNS.wordStart]))
        break;
    }
  } else {
    bttvForVKNS.wordStart = bttvForVKNS.cursorIndex;
    if (bttvForVKNS.cursorIndex > 0 && currentNodeText [bttvForVKNS.cursorIndex-1])
      spaceBefore = " ";
  }
  if (bttvForVKNS.twoLayers)
    bttvForVKNS.input.childNodes[bttvForVKNS.activeYNode].childNodes[bttvForVKNS.activeXNode].nodeValue = currentNodeText.substr(0,bttvForVKNS.wordStart+1) + spaceBefore + name + " " + currentNodeText .substr(bttvForVKNS.cursorIndex);
  else
    bttvForVKNS.input.childNodes[bttvForVKNS.activeYNode].nodeValue = currentNodeText.substr(0,bttvForVKNS.wordStart+1) + spaceBefore + name + " " + currentNodeText .substr(bttvForVKNS.cursorIndex);
  bttvForVKNS.cursorIndex = bttvForVKNS.wordStart + name.length + 1 + (spaceBefore == " ");
  bttvForVKNS.input.focus();
  var sel = window.getSelection();
  range = sel.getRangeAt(0);
  if (bttvForVKNS.twoLayers)
    range.setStart(bttvForVKNS.input.childNodes[bttvForVKNS.activeYNode].childNodes[bttvForVKNS.activeXNode], bttvForVKNS.cursorIndex);
  else
    range.setStart(bttvForVKNS.input.childNodes[bttvForVKNS.activeYNode], bttvForVKNS.cursorIndex);
  range.collapse(false);
  sel.removeAllRanges();
  sel.addRange(range);
}
bttvForVKNS.predictedEmotes = Object.keys(bttvForVKNS.bttvEmotes);
bttvForVKNS.predictErrorMsg = bttvForVKNS.createElement("div", {"className": "bttv_predcited-error--inner", "innerHTML": "No such emote"});
bttvForVKNS.predictedMenu = bttvForVKNS.createElement("ul", {"className": "bttv_predicted-menu"});
bttvForVKNS.predictEmote = function(e) {
  if (e.code == "Tab") {
    bttvForVKNS.predictedMenu.style.display = "none";

    if (!bttvForVKNS.lastPressedTab) {
      if (bttvForVKNS.updateCursorPlacement())
        return;
    }
    if (bttvForVKNS.input.childNodes[bttvForVKNS.activeYNode].nodeName != "#text" && !bttvForVKNS.twoLayers)
      return;

    var currentNodeText;
    if (bttvForVKNS.twoLayers)
      currentNodeText = bttvForVKNS.input.childNodes[bttvForVKNS.activeYNode].childNodes[bttvForVKNS.activeXNode].nodeValue;
    else
      currentNodeText = bttvForVKNS.input.childNodes[bttvForVKNS.activeYNode].nodeValue;

    if (currentNodeText.length == 0)
      return;
    if (!bttvForVKNS.lastPressedTab) {
      var wordBeforeTabbed = "";
      for (bttvForVKNS.wordStart = bttvForVKNS.cursorIndex-1; bttvForVKNS.wordStart >= 0; bttvForVKNS.wordStart--) {
        if (/\s/.test(currentNodeText[bttvForVKNS.wordStart]))
          break;
        wordBeforeTabbed = currentNodeText[bttvForVKNS.wordStart] + wordBeforeTabbed;
      }
      if (wordBeforeTabbed == "")
        return;
      bttvForVKNS.predictedEmotes = Object.keys(bttvForVKNS.bttvEmotes).filter(emote => emote.toLowerCase().startsWith(wordBeforeTabbed.toLowerCase()));
      bttvForVKNS.lastPressedTab = true;
    }
    if (bttvForVKNS.predictedEmotes.length == 0)
      bttvForVKNS.predictErrorMsg.style.opacity = 1;
    else {
      var range = document.createRange();
      var sel = window.getSelection();
      if (bttvForVKNS.twoLayers)
        bttvForVKNS.input.childNodes[bttvForVKNS.activeYNode].childNodes[bttvForVKNS.activeXNode].nodeValue = currentNodeText.substr(0, bttvForVKNS.wordStart+1) + bttvForVKNS.predictedEmotes[bttvForVKNS.lastTabbedEmote] + ' ' + currentNodeText.substr(bttvForVKNS.cursorIndex);
      else
        bttvForVKNS.input.childNodes[bttvForVKNS.activeYNode].nodeValue = currentNodeText.substr(0, bttvForVKNS.wordStart+1) + bttvForVKNS.predictedEmotes[bttvForVKNS.lastTabbedEmote] + ' ' + currentNodeText.substr(bttvForVKNS.cursorIndex);
      bttvForVKNS.cursorIndex = bttvForVKNS.wordStart + bttvForVKNS.predictedEmotes[bttvForVKNS.lastTabbedEmote].length + 2;
      if (bttvForVKNS.twoLayers)
        range.setStart(bttvForVKNS.input.childNodes[bttvForVKNS.activeYNode].childNodes[bttvForVKNS.activeXNode], bttvForVKNS.cursorIndex);
      else
        range.setStart(bttvForVKNS.input.childNodes[bttvForVKNS.activeYNode], bttvForVKNS.cursorIndex);
      range.collapse(false);
      sel.removeAllRanges();
      sel.addRange(range);

      bttvForVKNS.lastTabbedEmote = (bttvForVKNS.lastTabbedEmote+1 == bttvForVKNS.predictedEmotes.length ? 0 : bttvForVKNS.lastTabbedEmote+1);
    }

    e.stopPropagation();
    e.preventDefault();
  } else if (bttvForVKNS.settings.predictedMenu) {
    if (e.key == ' ')
      bttvForVKNS.predictedMenu.style.display = "none";
    else {
      if (bttvForVKNS.updateCursorPlacement())
        return;

      var currentNodeText;
      if (bttvForVKNS.input.childNodes.length > 0) {
        if (bttvForVKNS.input.childNodes[bttvForVKNS.activeYNode].nodeName != "#text" && !bttvForVKNS.twoLayers)
          return;
        if (bttvForVKNS.twoLayers)
          currentNodeText = bttvForVKNS.input.childNodes[bttvForVKNS.activeYNode].childNodes[bttvForVKNS.activeXNode].nodeValue;
        else
          currentNodeText = bttvForVKNS.input.childNodes[bttvForVKNS.activeYNode].nodeValue;
      } else
        currentNodeText = e.key;

      var wordBeforeTabbed = "";
      for (bttvForVKNS.wordStart = bttvForVKNS.cursorIndex-1; bttvForVKNS.wordStart >= 0; bttvForVKNS.wordStart--) {
        if (/\s/.test(currentNodeText[bttvForVKNS.wordStart]))
          break;
        wordBeforeTabbed = currentNodeText[bttvForVKNS.wordStart] + wordBeforeTabbed;
      }
      wordBeforeTabbed += e.key;

      if (wordBeforeTabbed == "")
        bttvForVKNS.predictedEmotes = [];
      else
        bttvForVKNS.predictedEmotes = Object.keys(bttvForVKNS.bttvEmotes).filter(emote => emote.toLowerCase().startsWith(wordBeforeTabbed.toLowerCase()) &&
         (bttvForVKNS.settings.showGifs || !bttvForVKNS.bttvEmotes[emote].animated) &&
         (bttvForVKNS.settings.frankerZEmotes || !bttvForVKNS.bttvEmotes[emote].frankerfacez));

      if (bttvForVKNS.predictedEmotes.length == 0)
        bttvForVKNS.predictedMenu.style.display = "none";
      else {
        bttvForVKNS.predictedMenu.innerHTML = "";
        for (var e of bttvForVKNS.predictedEmotes) {
          var emote = bttvForVKNS.bttvEmotes[e];
          var item = bttvForVKNS.createElement("li", {
            "className": "bttv_predicted-item",
            "innerHTML": e,
            "bttv_emoteName": e}, [
            bttvForVKNS.createElement("img", {
              "height": "28",
              "src": "https://cdn.betterttv.net/" + (emote.frankerfacez ? "frankerfacez_emote/" : "emote/") + emote.id + "/" + emote.size
            })
          ]);
          item.addEventListener("click", function() {
            bttvForVKNS.insertInEditable(this.bttv_emoteName, true);
            bttvForVKNS.predictedMenu.style.display = "none";
          });
          bttvForVKNS.predictedMenu.appendChild(item);
        }
        bttvForVKNS.predictedMenu.style.display = "block";
      }
    }

    bttvForVKNS.lastTabbedEmote = 0;
    bttvForVKNS.lastPressedTab = false;
    bttvForVKNS.predictErrorMsg.style.opacity = 0;
  }
}
bttvForVKNS.scrollbar = bttvForVKNS.createElement("div", {className: "bttv_emotes-scrollbar"});
bttvForVKNS.scrollbar.addEventListener("mousedown", function(e) {
  e.preventDefault();
  bttvForVKNS.scrollbar.style.webkitTransition = "none";
  bttvForVKNS.scrollbar.style.transition = "none";
  bttvForVKNS.menuDraggingBar = true;
  bttvForVKNS.menuStartDraggingPoint = e.pageY;
});

bttvForVKNS.emoteContainer = [
  bttvForVKNS.createElement("div", {className:"bttv_emotes-wall"}),
  bttvForVKNS.createElement("div", {className:"bttv_emotes-wall"})
];

bttvForVKNS.emoteScrollable = bttvForVKNS.createElement("div", {className: "bttv_emotes-scrollable--inner"},[
  bttvForVKNS.createElement("div", {className:"bttv_emotes-group"},[
    bttvForVKNS.createElement("div", {
      className:"bttv_emotes-group--title",
      innerHTML:"BTTV Emotes"
    }),
    bttvForVKNS.emoteContainer[0]
  ]),
  bttvForVKNS.createElement("div", {className:"bttv_emotes-group"},[
    bttvForVKNS.createElement("div", {
      className:"bttv_emotes-group--title",
      innerHTML:"FrankerFaceZ Emotes"
    }),
    bttvForVKNS.emoteContainer[1]
  ])
]);
bttvForVKNS.emoteScrollable.addEventListener('onwheel' in document.createElement('div') ? 'wheel' : 'mousewheel', function(e) {
  bttvForVKNS.handleScrollBar(bttvForVKNS.menuScrollOffset+e.deltaY);
});

bttvForVKNS.emotesMenu = bttvForVKNS.createElement("div", {className:"bttv_emotes-menu"},[
  bttvForVKNS.createElement("div", {className:"bttv_emotes-scrollable"},[bttvForVKNS.emoteScrollable]),
  bttvForVKNS.createElement("div", {className:"bttv_emotes-scrollarea"},[bttvForVKNS.scrollbar]),
]);
bttvForVKNS.emoteButtonImage = bttvForVKNS.createElement("div", {"className": "bttv_emote-button-image"});
bttvForVKNS.emoteButtonWrapper = bttvForVKNS.createElement("div", {"className": "bttv_emote-button-wrapper"}, [bttvForVKNS.emoteButtonImage]);

bttvForVKNS.fillEmotesMenu = function() {
  bttvForVKNS.emoteContainer[0].innerHTML = "";
  bttvForVKNS.emoteContainer[1].innerHTML = "";
  for (var name in bttvForVKNS.bttvEmotes) {
    var emote = bttvForVKNS.bttvEmotes[name];
    if (!bttvForVKNS.settings.showGifs && emote.animated)
      continue;
    var emotePreview = bttvForVKNS.createElement("div", {
      "title": name,
      "className": "bttv_emotes-preview"
    }, [
      bttvForVKNS.createElement("img", {
        "src": "https://cdn.betterttv.net/" + (emote.frankerfacez ? "frankerfacez_emote/" : "emote/") + emote.id + "/" + emote.size,
        "className": "bttv_emotes-preview--image",
        "alt": name
      })
    ]);

    emotePreview.addEventListener("click", function() {
      bttvForVKNS.insertInEditable(this.title);
    });
    if (emote.frankerfacez) {
      if (bttvForVKNS.settings.frankerZEmotes)
        bttvForVKNS.emoteContainer[1].appendChild(emotePreview);
    }
    else
      bttvForVKNS.emoteContainer[0].appendChild(emotePreview);
  }
}

bttvForVKNS.emoteButtonWrapper.addEventListener("click", function() {
  if (bttvForVKNS.emotesMenuShown) {
    bttvForVKNS.emotesMenu.style.display = "none";
    bttvForVKNS.emoteButtonImage.style.webkitFilter = "grayscale(100%)";
    bttvForVKNS.emoteButtonImage.style.filter = "grayscale(100%)";
  } else {
    var emotesMenuCoors = bttvForVKNS.emoteButtonWrapper.getBoundingClientRect();
    bttvForVKNS.emotesMenu.style.top = emotesMenuCoors.top - bttvForVKNS.emotesMenuSizes.height + "px";
    bttvForVKNS.emotesMenu.style.left = emotesMenuCoors.left - bttvForVKNS.emotesMenuSizes.width/2 + "px";
    bttvForVKNS.emotesMenu.style.display = "block";
    bttvForVKNS.emoteButtonImage.style.webkitFilter = "none";
    bttvForVKNS.emoteButtonImage.style.filter = "none";
  }
  bttvForVKNS.emotesMenuShown = !bttvForVKNS.emotesMenuShown;
});

bttvForVKNS.appendPredictedMenu = function() {
  document.getElementsByClassName("im-page--chat-input")[0].appendChild(bttvForVKNS.predictedMenu);
}
bttvForVKNS.appendEmoteMenu = function() {
  var inputButtons = document.getElementsByClassName("im_chat-input--buttons")[0];
  inputButtons.insertBefore(bttvForVKNS.emoteButtonWrapper, inputButtons.children[2]);
}

bttvForVKNS.visualizeEmotesOnPage = function() {
  // All messages
  for (var el of document.getElementsByClassName("im-mess--text wall_module"))
    bttvForVKNS.replaceEmotes(el);

  // All replies
  for (var el of document.getElementsByClassName("im-replied--text"))
    bttvForVKNS.replaceEmotes(el);

  // All dialog previews
  for (var el of document.getElementsByClassName("nim-dialog--preview")) {
    if (el.lastElementChild !== null && el.lastElementChild.className == "nim-dialog--inner-text")
      bttvForVKNS.replaceEmotes(el.lastElementChild);
    else
      bttvForVKNS.replaceEmotes(el);
  }

  if (bttvForVKNS.settings.predictedMenu)
    bttvForVKNS.appendPredictedMenu();

  if (bttvForVKNS.settings.emoteMenu)
    bttvForVKNS.appendEmoteMenu();

  document.getElementsByClassName("im-page--chat-input")[0].appendChild(bttvForVKNS.createElement("div", {"className": "bttv_predicted-error"}, [bttvForVKNS.predictErrorMsg]));

  // Attached fowared message
  var fwd_msg = document.getElementsByClassName("im-fwd im-fwd_msg");
  if (fwd_msg.length == 1)
    bttvForVKNS.replaceEmotes(fwd_msg[0].lastElementChild);

  bttvForVKNS.input = document.getElementsByClassName("im-chat-input--text im_editable")[0];
  bttvForVKNS.input.addEventListener("blur", function() {
    switch (bttvForVKNS.updateCursorPlacement()) {
      case 1:
        bttvForVKNS.twoLayers = false;
        bttvForVKNS.activeYNode = 0;
        bttvForVKNS.activeXNode = 0;
        bttvForVKNS.cursorIndex = 0;
        break;
    }
    typing = false;
  });
}

// Emote Autocomplete
if (window.getSelection) {
  window.addEventListener("keydown", function(e) {
    if (e.target == bttvForVKNS.input)
      bttvForVKNS.predictEmote(e);
  }, {capture: true});
}

window.addEventListener("bttvForVKSettingsChange", function(e) {
  bttvForVKNS.settings = e.detail.bttvForVK;
  if (e.detail.action === "load") {
    bttvForVKNS.fillEmotesMenu();
    document.body.appendChild(bttvForVKNS.emotesMenu);

    bttvForVKNS.emotesMenuSizes = {
      height: bttvForVKNS.emotesMenu.clientHeight,
      width: bttvForVKNS.emotesMenu.clientWidth
    };
    bttvForVKNS.scrollHeight = bttvForVKNS.emoteScrollable.scrollHeight;
    bttvForVKNS.scrollareaHeight = bttvForVKNS.emotesMenuSizes.height;
    bttvForVKNS.scrollSpace = bttvForVKNS.scrollHeight-bttvForVKNS.scrollareaHeight;
    bttvForVKNS.scrollbar.style.height = bttvForVKNS.scrollareaHeight*bttvForVKNS.scrollareaHeight/bttvForVKNS.scrollHeight + "px";

    bttvForVKNS.emotesMenu.style.display = "none";

    bttvForVKNS.vk_se = window.se;
    window.se = function(t) {
      var i = document.createElement("div");
      i.innerHTML = t;
      try {
        var name = i.firstElementChild.classList[0];
        if (name == "nim-dialog" || name == "im-mess") {
          var msgBody = i.firstElementChild.firstElementChild;
          if (msgBody !== null)
            bttvForVKNS.replaceEmotes(msgBody);
          msgBody = i.firstElementChild.lastElementChild.firstElementChild;
          if (msgBody !== null) {
            msgBody = msgBody.children[5].firstElementChild;
            if (msgBody.lastElementChild !== null && msgBody.lastElementChild.className == "nim-dialog--inner-text")
              bttvForVKNS.replaceEmotes(msgBody.lastElementChild);
            else
              bttvForVKNS.replaceEmotes(msgBody);
          }
        }
      } catch (e) {}
      return bttvForVKNS.vk_se(i.innerHTML);
    }

    bttvForVKNS.vk_sech = window.sech;
    window.sech = function(t) {
      var i = document.createElement("div");
      i.innerHTML = t;
      for (var el of i.getElementsByClassName("im-mess--text wall_module"))
        bttvForVKNS.replaceEmotes(el);
      return bttvForVKNS.vk_sech(i.innerHTML);
    }

    bttvForVKNS.vk_val = window.val;
    window.val = function(t) {
      var e = arguments.length > 1 && void 0 !== arguments[1] ? arguments[1] : void 0;
      if (void 0 !== e && e != "" && t !== undefined) {
        var i = document.createElement("div");
        i.innerHTML = e;
        // load new messages
        if (i.children.length > 0 && (i.firstElementChild.classList[0] === "im-mess-stack" || i.firstElementChild.classList[0] === "im-page--history-new-bar")) { 
          for (var el of i.getElementsByClassName("im-mess--text wall_module"))
            bttvForVKNS.replaceEmotes(el);
          arguments[1] = i.innerHTML;
        }
        else if (i.children.length > 1 && i.lastElementChild.className == "nim-dialog--inner-text") {
          bttvForVKNS.replaceEmotes(i.children[1]);
          arguments[1] = i.innerHTML;
        }
        // new sent message in dialog tab
        else if (t.classList !== undefined && t.classList[0] == "nim-dialog--preview") {
          bttvForVKNS.replaceEmotes(i);
          arguments[1] = i.innerHTML;
        }
      }
      return bttvForVKNS.vk_val(...arguments);
    }

    // Attached reply
    bttvForVKNS.vk_getTemplate = window.getTemplate;
    window.getTemplate = function(t, e) {
      if (t == "im_replied_message") {
        var i = document.createElement("div");
        for (var n of bttvForVKNS.parseEmotes(e.text))
          i.appendChild(n);
        e.text = i.innerHTML;
      }
      return bttvForVKNS.vk_getTemplate(t, e);
    }

    if (document.getElementsByClassName("im-page-wrapper").length > 0)
      bttvForVKNS.visualizeEmotesOnPage();

    // Starred and forwarded tab
    bttvForVKNS.boxLayerObserver = new (window.MutationObserver || window.WebKitMutationObserver)(function(muts, o) {
      try {
        if (muts[1].addedNodes[0].className == "im_single_log_wrap") {
          for (var el of muts[1].addedNodes[0].getElementsByClassName("im-mess--text wall_module"))
            bttvForVKNS.replaceEmotes(el);
        } else if (muts[0].addedNodes[0].classList[1] == "im-important-box") {
          for (var el of muts[0].addedNodes[0].getElementsByClassName("im-mess--text wall_module"))
            bttvForVKNS.replaceEmotes(el);
        }
      } catch (e) {}
    });

    bttvForVKNS.boxLayerObserver.observe(document.getElementById("box_layer"), {
      subtree: true,
      attributes: false,
      childList: true
    });

    bttvForVKNS.imObserver = new (window.MutationObserver || window.WebKitMutationObserver)(function(muts, o) {
      try {
        if (muts[0].target.id == "wrap3" && muts[0].addedNodes[0].id == "wrap2" && muts[0].addedNodes[0].firstElementChild.firstElementChild.firstElementChild.classList[0] == "im-page-wrapper")
          bttvForVKNS.visualizeEmotesOnPage();
        else if (muts[1].target.id == "im_dialogs" && muts[1].addedNodes[0].classList[0] == "nim-dialog") {
          var el;
          for (var m of muts) {
            if (m.addedNodes.length > 0) {
              el = m.addedNodes[0].lastElementChild.firstElementChild.children[5].firstElementChild;
              if (el.lastElementChild !== null && el.lastElementChild.className == "nim-dialog--inner-text")
                bttvForVKNS.replaceEmotes(el.lastElementChild);
              else
                bttvForVKNS.replaceEmotes(el);
            }
          }
        } else if (muts[0].target.classList[1] == "im-chat-input--fwd" && muts[0].addedNodes[1].classList[1] == "im-fwd_msg")
          bttvForVKNS.replaceEmotes(muts[0].addedNodes[1].lastElementChild);
        else if (muts[0].target.className.substr(0,13) == "_im_msg_reply") {
          var container = muts[0].addedNodes[0].lastElementChild.lastElementChild;
          var child = container.childNodes[0];
          if (child.nodeName === "#text") {
            for (var n of bttvForVKNS.parseEmotes(child.nodeValue))
              container.insertBefore(n, child);
            child.remove();
          }
        } else if (muts[0].target.className.substr(0,13) == "_im_msg_media") {
          for (var el of muts[0].target.getElementsByClassName("im-mess--text wall_module"))
            bttvForVKNS.replaceEmotes(el);
        }
      } catch (e) {}
    });

    bttvForVKNS.imObserver.observe(document.getElementById("wrap3"), {
      subtree: true,
      attributes: false,
      childList: true
    });

    window.addEventListener("mouseup", function(e) {
      e.preventDefault();
      bttvForVKNS.scrollbar.style.webkitTransition = ".2s";
      bttvForVKNS.scrollbar.style.transition = ".2s";
      bttvForVKNS.menuDraggingBar = false;
    });
    window.addEventListener("mousemove", function(e) {
      if (bttvForVKNS.menuDraggingBar) {
        bttvForVKNS.handleScrollBar(bttvForVKNS.menuScrollOffset+e.pageY-bttvForVKNS.menuStartDraggingPoint, true);
        bttvForVKNS.menuStartDraggingPoint = e.pageY;
      }
    });
  } else if (e.detail.action === "update") {
    if (e.detail.updated === "predictedMenu") {
      if (bttvForVKNS.settings.predictedMenu)
        bttvForVKNS.appendPredictedMenu();
      else
        document.getElementsByClassName("im-page--chat-input")[0].removeChild(bttvForVKNS.predictedMenu);
    } else if (e.detail.updated === "emoteMenu") {
      if (bttvForVKNS.settings.emoteMenu)
        bttvForVKNS.appendEmoteMenu();
      else {
        document.getElementsByClassName("im_chat-input--buttons")[0].removeChild(bttvForVKNS.emoteButtonWrapper);
        bttvForVKNS.emotesMenu.style.display = "none";
        bttvForVKNS.emoteButtonImage.style.webkitFilter = "grayscale(100%)";
        bttvForVKNS.emoteButtonImage.style.filter = "grayscale(100%)";
        bttvForVKNS.emotesMenuShown = false;
      }
    } else if (e.detail.updated === "showGifs")
      bttvForVKNS.fillEmotesMenu();
  }
});

window.addEventListener("click", function(e) {
  var path = e.path || (e.composedPath && e.composedPath());
  if (bttvForVKNS.emotesMenuShown && !(path.includes(bttvForVKNS.emotesMenu) || path.includes(bttvForVKNS.emoteButtonWrapper))) {
    bttvForVKNS.emotesMenu.style.display = "none";
    bttvForVKNS.emoteButtonImage.style.webkitFilter = "grayscale(100%)";
    bttvForVKNS.emoteButtonImage.style.filter = "grayscale(100%)";
    bttvForVKNS.emotesMenuShown = false;
  }
  if (!path.includes(bttvForVKNS.predictedMenu))
    bttvForVKNS.predictedMenu.style.display = "none";
});